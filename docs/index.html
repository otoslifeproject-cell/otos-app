<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OTOS Cockpit</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <!-- Ambient background -->
    <div class="bg">
      <div class="bg__blob bg__blob--a"></div>
      <div class="bg__blob bg__blob--b"></div>
      <div class="bg__blob bg__blob--c"></div>
      <div class="bg__noise" aria-hidden="true"></div>
    </div>

    <!-- Focus overlay -->
    <div id="focusOverlay" class="focusOverlay" hidden></div>

    <!-- Shell -->
    <div class="shell">
      <!-- Header -->
      <header class="header zone" data-zone="header" data-default-x="64" data-default-y="32">
        <div class="zone__handle" title="Drag Â· double-click to FloatBack">
          <span class="chip">OTOS</span>
          <span class="muted">CEO Context Â· Render Layer</span>
          <span class="spacer"></span>
          <span class="chip chip--soft">Focus: <b id="focusLabel">Primary Action</b></span>
        </div>

        <div class="header__title">
          <h1>OTOS Cockpit</h1>
          <p class="muted">Glassmorphism Â· Neuro-calm motion Â· Snap-to-grid Zones</p>
        </div>
      </header>

      <!-- Parent Node Home (placeholder â€œhomeâ€ for Parent Chat window) -->
      <section class="parentHome zone" data-zone="parentHome" data-default-x="64" data-default-y="148">
        <div class="zone__handle" title="Drag Â· double-click to FloatBack">
          <span class="emoji">ğŸ‘ï¸</span>
          <b>Parent Node Â· Home</b>
          <span class="muted">Reasoning Â· Decisions Â· Memory</span>
          <span class="spacer"></span>
          <span class="chip chip--soft">Dock</span>
        </div>

        <div class="parentHome__body">
          <div class="parentHome__line">
            <span class="dot dot--green"></span>
            <span class="muted">This zone is the â€œhome slotâ€ for your Parent Node chat window.</span>
          </div>
          <div class="parentHome__line">
            <span class="dot dot--blue"></span>
            <span class="muted">In the product, this becomes a live docked panel (Chat / Memory / Commands).</span>
          </div>
          <div class="parentHome__line">
            <span class="dot dot--amber"></span>
            <span class="muted">Double-click handle to FloatBack. Drag anywhere. Snaps to grid.</span>
          </div>
        </div>
      </section>

      <!-- Central Action Deck (Primary Single Action + fanned next actions) -->
      <main class="centre zone" data-zone="centre" data-default-x="520" data-default-y="220">
        <div class="zone__handle" title="Drag Â· double-click to FloatBack">
          <span class="emoji">ğŸ§ </span>
          <b>Primary Single Action</b>
          <span class="muted">Deck Â· Reward Â· Re-order</span>
          <span class="spacer"></span>
          <span class="chip chip--soft">Click #1 for Focus</span>
        </div>

        <div class="centre__body">
          <div class="deckHeader">
            <div>
              <div class="deckHeader__kicker">CENTRE TILE</div>
              <div class="deckHeader__title">Action Deck</div>
              <div class="deckHeader__sub muted">
                #1 is always front-and-centre. Next actions fan underneath. Click to promote.
              </div>
            </div>
            <div class="deckHeader__controls">
              <button class="btn btn--ghost" id="shuffleBtn" type="button" title="Demo shuffle">
                Shuffle
              </button>
              <button class="btn" id="resetDeckBtn" type="button" title="Reset demo deck">
                Reset Deck
              </button>
            </div>
          </div>

          <div id="deckStage" class="deckStage" aria-label="Action deck stage"></div>

          <div class="hintRow muted">
            Tip: hover a lower card for â€œquick lookâ€. Click a lower card to bring it to #1. Click #1 again to
            enter Focus Mode. ESC exits.
          </div>
        </div>
      </main>

      <!-- PA Zone (Personal Cognitive Companion) -->
      <aside class="pa zone" data-zone="pa" data-default-x="1220" data-default-y="420">
        <div class="zone__handle" title="Drag Â· double-click to FloatBack">
          <span class="emoji">ğŸ«§</span>
          <b>PA Zone</b>
          <span class="muted">Personal assistant Â· regulation Â· capture</span>
          <span class="spacer"></span>
          <span class="chip chip--pink">10/10 dial (soon)</span>
        </div>

        <div class="pa__body">
          <div class="pa__grid">
            <button class="pill" type="button" id="capThought">ğŸ—’ï¸ Capture thought</button>
            <button class="pill" type="button" id="realityCheck">ğŸ§­ Reality check</button>
            <button class="pill pill--soft" type="button" id="reset">ğŸ” Reset</button>
            <button class="pill pill--soft" type="button" id="voiceNote">ğŸ™ï¸ Voice note â†’ Action</button>
          </div>

          <div class="pa__log" id="paLog" aria-live="polite">
            <div class="pa__logTitle">PA Feed</div>
            <div class="pa__logItem muted">Ready. Capture pushes into the Action Deck (demo).</div>
          </div>
        </div>
      </aside>

      <!-- Signals / Status (tiny skeleton for â€œmore depthâ€) -->
      <section class="signals zone" data-zone="signals" data-default-x="64" data-default-y="392">
        <div class="zone__handle" title="Drag Â· double-click to FloatBack">
          <span class="emoji">ğŸ“¡</span>
          <b>Signals</b>
          <span class="muted">quiet alerts</span>
          <span class="spacer"></span>
          <span class="chip chip--soft">Skeleton</span>
        </div>

        <div class="signals__body">
          <div class="sig">
            <span class="sig__icon">â³</span>
            <div>
              <div class="sig__title">Repeating personal task due</div>
              <div class="sig__sub muted">PA will escalate to #1 when time-critical.</div>
            </div>
          </div>

          <div class="sig">
            <span class="sig__icon">âš‘</span>
            <div>
              <div class="sig__title">Opportunity flagged</div>
              <div class="sig__sub muted">Routes to MD zones or CEO focus (later).</div>
            </div>
          </div>
        </div>
      </section>

      <footer class="footer">
        <div class="footer__line muted">
          Render-only Â· Single Task Truth Â· Spine-authoritative Â· Zones movable Â· Glass UI
        </div>
      </footer>
    </div>

    <script>
      /***********************
       * Demo Data (Actions)
       ***********************/
      const DEFAULT_ACTIONS = [
        {
          id: "a1",
          title: "Define next cockpit layer",
          meta: "CEO Â· Primary Â· Score 65.54",
          body: "This is the one thing that matters now.",
          tone: "primary",
        },
        {
          id: "a2",
          title: "Prepare screenshot route list for sales animation storyboard",
          meta: "MD Â· Next Â· Score 24",
          body: "Build the visual route for the story (calm, ND-safe, reward-driven).",
          tone: "md",
        },
        {
          id: "a3",
          title: "Draft MD cockpit default modules for OTOS Life",
          meta: "MD Â· Next Â· Score 23.1",
          body: "Define the default module layout and task routing boundaries.",
          tone: "md",
        },
        {
          id: "a4",
          title: "Validate Spine â†’ Cockpit authority boundaries",
          meta: "CEO Â· Next Â· Score 18.2",
          body: "Confirm what the cockpit can suggest vs what the spine can authorise.",
          tone: "ceo",
        },
        {
          id: "a5",
          title: "Confirm demo routes for focus switching",
          meta: "PROJECT Â· Next Â· Score 15.4",
          body: "Confirm the routes and the transitions between zones.",
          tone: "project",
        },
        {
          id: "a6",
          title: "Add â€˜Flip to Backsideâ€™ dev view (Reason-style)",
          meta: "DEV Â· Could Â· Spec",
          body: "Instant 180Â° flip to wiring/config view with gentle slack motion.",
          tone: "dev",
        },
      ];

      let actions = loadDeck() ?? structuredClone(DEFAULT_ACTIONS);

      const deckStage = document.getElementById("deckStage");
      const focusOverlay = document.getElementById("focusOverlay");
      const focusLabel = document.getElementById("focusLabel");

      let focusMode = false;

      function saveDeck() {
        localStorage.setItem("otos_deck_actions_v1", JSON.stringify(actions));
      }
      function loadDeck() {
        try {
          const raw = localStorage.getItem("otos_deck_actions_v1");
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : null;
        } catch (e) {
          return null;
        }
      }

      /***********************
       * Deck Rendering
       ***********************/
      function renderDeck() {
        deckStage.innerHTML = "";

        // Top card is index 0. Next visible fan cards are 1..4
        const top = actions[0];
        const fan = actions.slice(1, 5);

        const wrap = document.createElement("div");
        wrap.className = "deckWrap";
        deckStage.appendChild(wrap);

        // Fan cards first (so top card sits above them)
        fan.forEach((item, idx) => {
          const card = createCard(item, { role: "fan", index: idx + 1 });
          // position: show half overlap edges, spreading from centre
          card.style.setProperty("--fan-i", idx + 1);
          wrap.appendChild(card);
        });

        // Top card
        const topCard = createCard(top, { role: "top", index: 0 });
        wrap.appendChild(topCard);

        // Update focus label
        focusLabel.textContent = "Primary Action";
      }

      function createCard(item, opts) {
        const card = document.createElement("article");
        card.className = `card card--${opts.role} tone--${item.tone}`;
        card.setAttribute("data-id", item.id);
        card.setAttribute("tabindex", "0");

        card.innerHTML = `
          <div class="card__inner">
            <div class="card__top">
              <div class="card__title">${escapeHTML(item.title)}</div>
              <div class="card__meta">${escapeHTML(item.meta)}</div>
            </div>
            <div class="card__body">${escapeHTML(item.body)}</div>
            <div class="card__hint">${opts.role === "top" ? "Click to Focus Â· ESC to exit" : "Click to promote"}</div>
          </div>
        `;

        // Interactions
        if (opts.role === "fan") {
          // quick-look on hover
          card.addEventListener("mouseenter", () => {
            if (focusMode) return;
            card.classList.add("is-peek");
          });
          card.addEventListener("mouseleave", () => {
            card.classList.remove("is-peek");
          });

          // click to promote to top
          card.addEventListener("click", (e) => {
            e.stopPropagation();
            if (focusMode) return;
            promoteToTop(item.id);
          });
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              if (focusMode) return;
              promoteToTop(item.id);
            }
          });
        }

        if (opts.role === "top") {
          card.addEventListener("click", (e) => {
            e.stopPropagation();
            toggleFocusMode(true);
          });
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              toggleFocusMode(true);
            }
          });
        }

        return card;
      }

      function promoteToTop(id) {
        const idx = actions.findIndex((a) => a.id === id);
        if (idx <= 0) return;

        const selected = actions[idx];
        actions.splice(idx, 1);
        actions.unshift(selected);

        saveDeck();
        animateDeckReorder();
      }

      function animateDeckReorder() {
        // small â€œrewardâ€ motion â€“ fade/slide
        deckStage.classList.add("deckStage--pulse");
        renderDeck();
        requestAnimationFrame(() => {
          setTimeout(() => deckStage.classList.remove("deckStage--pulse"), 380);
        });
      }

      /***********************
       * Focus Mode (2nd click feel)
       ***********************/
      function toggleFocusMode(forceOn) {
        const next = forceOn === true ? true : !focusMode;
        focusMode = next;

        document.body.classList.toggle("is-focus", focusMode);
        focusOverlay.hidden = !focusMode;

        if (focusMode) {
          focusOverlay.classList.remove("focusOverlay--out");
          focusOverlay.classList.add("focusOverlay--in");
        } else {
          focusOverlay.classList.remove("focusOverlay--in");
          focusOverlay.classList.add("focusOverlay--out");
        }
      }

      focusOverlay.addEventListener("click", () => toggleFocusMode(false));
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && focusMode) toggleFocusMode(false);
      });

      /***********************
       * PA actions (demo)
       * - pushes into deck
       ***********************/
      const paLog = document.getElementById("paLog");

      function logPA(text) {
        const row = document.createElement("div");
        row.className = "pa__logItem";
        row.textContent = text;
        paLog.appendChild(row);
        paLog.scrollTop = paLog.scrollHeight;
      }

      document.getElementById("capThought").addEventListener("click", () => {
        const id = "pa_" + Math.random().toString(16).slice(2);
        actions.splice(1, 0, {
          id,
          title: "Captured thought (PA)",
          meta: "PA Â· Personal Â· Routed to Next",
          body: "Captured into your pathway. Click to promote when ready.",
          tone: "pa",
        });
        actions = actions.slice(0, 16);
        saveDeck();
        animateDeckReorder();
        logPA("ğŸ—’ï¸ Captured thought â†’ inserted into Action Deck.");
      });

      document.getElementById("realityCheck").addEventListener("click", () => {
        logPA("ğŸ§­ Reality check: breathe 3 mins Â· pick the *one* next action.");
        // gentle nudge: bring #1 into focus softly
        toggleFocusMode(true);
      });

      document.getElementById("reset").addEventListener("click", () => {
        actions = structuredClone(DEFAULT_ACTIONS);
        saveDeck();
        renderDeck();
        logPA("ğŸ” Reset: deck restored to demo defaults.");
      });

      document.getElementById("voiceNote").addEventListener("click", () => {
        logPA("ğŸ™ï¸ Voice note received (demo). In product: Whisper â†’ Extract â†’ Action + Notes.");
        const id = "vn_" + Math.random().toString(16).slice(2);
        actions.splice(1, 0, {
          id,
          title: "Voice note â†’ Action (PA)",
          meta: "PA Â· Personal Â· Time-critical",
          body: "Voice note transcribed + extracted into actions & notes (demo placeholder).",
          tone: "pa",
        });
        actions = actions.slice(0, 16);
        saveDeck();
        animateDeckReorder();
      });

      /***********************
       * Controls
       ***********************/
      document.getElementById("resetDeckBtn").addEventListener("click", () => {
        actions = structuredClone(DEFAULT_ACTIONS);
        saveDeck();
        renderDeck();
      });

      document.getElementById("shuffleBtn").addEventListener("click", () => {
        if (focusMode) toggleFocusMode(false);
        // shuffle everything except keep one random as top
        actions = actions
          .map((a) => ({ a, r: Math.random() }))
          .sort((x, y) => x.r - y.r)
          .map((x) => x.a);
        saveDeck();
        animateDeckReorder();
      });

      /***********************
       * Zones: drag + snap + FloatBack
       ***********************/
      const GRID = 24;

      const zones = Array.from(document.querySelectorAll(".zone"));
      const defaults = new Map();

      zones.forEach((zone) => {
        const z = zone.getAttribute("data-zone");
        const dx = parseInt(zone.getAttribute("data-default-x") || "0", 10);
        const dy = parseInt(zone.getAttribute("data-default-y") || "0", 10);
        defaults.set(z, { x: dx, y: dy });

        // restore saved position
        const saved = loadZonePos(z);
        const pos = saved ?? { x: dx, y: dy };
        setZonePos(zone, pos.x, pos.y, false);

        const handle = zone.querySelector(".zone__handle");
        if (!handle) return;

        // floatback on double-click
        handle.addEventListener("dblclick", (e) => {
          e.preventDefault();
          const d = defaults.get(z);
          setZonePos(zone, d.x, d.y, true);
          saveZonePos(z, d.x, d.y);
        });

        // drag
        makeDraggable(zone, handle, z);
      });

      function makeDraggable(el, handle, key) {
        let startX = 0,
          startY = 0,
          originX = 0,
          originY = 0,
          dragging = false;

        handle.addEventListener("mousedown", (e) => {
          dragging = true;
          el.classList.add("is-dragging");
          startX = e.clientX;
          startY = e.clientY;
          const cur = getZonePos(el);
          originX = cur.x;
          originY = cur.y;

          window.addEventListener("mousemove", onMove);
          window.addEventListener("mouseup", onUp);
        });

        function onMove(e) {
          if (!dragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          setZonePos(el, originX + dx, originY + dy, false);
        }

        function onUp() {
          if (!dragging) return;
          dragging = false;
          el.classList.remove("is-dragging");
          window.removeEventListener("mousemove", onMove);
          window.removeEventListener("mouseup", onUp);

          // snap to grid
          const cur = getZonePos(el);
          const sx = Math.round(cur.x / GRID) * GRID;
          const sy = Math.round(cur.y / GRID) * GRID;
          setZonePos(el, sx, sy, true);
          saveZonePos(key, sx, sy);
        }
      }

      function setZonePos(el, x, y, animate) {
        if (animate) el.classList.add("is-animating");
        el.style.transform = `translate3d(${x}px, ${y}px, 0)`;
        el.dataset.x = String(x);
        el.dataset.y = String(y);
        if (animate) {
          setTimeout(() => el.classList.remove("is-animating"), 260);
        }
      }

      function getZonePos(el) {
        return {
          x: parseFloat(el.dataset.x || "0"),
          y: parseFloat(el.dataset.y || "0"),
        };
      }

      function saveZonePos(key, x, y) {
        localStorage.setItem("otos_zonepos_" + key, JSON.stringify({ x, y }));
      }
      function loadZonePos(key) {
        try {
          const raw = localStorage.getItem("otos_zonepos_" + key);
          if (!raw) return null;
          const p = JSON.parse(raw);
          if (typeof p?.x !== "number" || typeof p?.y !== "number") return null;
          return p;
        } catch (e) {
          return null;
        }
      }

      function escapeHTML(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      /***********************
       * Boot
       ***********************/
      renderDeck();
    </script>
  </body>
</html>
